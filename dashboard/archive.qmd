---
title: "JC Farms — Archived Batches (4–14)"
format:
  html:
    toc: true
    toc-depth: 2
    css: style.css
    embed-resources: true
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup

library(tidyverse)
library(lubridate)
library(bslib)
library(bsicons)
library(shiny)
library(gt)
library(glue)
library(kableExtra)
library(readxl)
library(scales)
library(formattable)
library(robotoolbox)
library(plotly)
library(knitr)

source(file = "./R-scripts/00-functions.R")

# Connect and load data
df_raw <- jc_connect_kobo()
df <- jc_clean_data(df_raw)

# Filter to archived batches (4-14)
archive_batches <- 4:14
df_archive <- df |> filter(as.integer(as.character(Batch_Number)) %in% archive_batches)
batch_summ <- jc_batch_summary(df_archive)

archived_batch_nums <- sort(unique(as.integer(as.character(df_archive$Batch_Number))), decreasing = TRUE)
```

::: {.callout-note}
This is an archive of batches 4–14. For the current dashboard (Batch 15 onwards), go to the [Main Dashboard](index.html).
:::

## Financial Summary

```{r}
batch_summ %>%
  select(Batch, revenue, cost, profit, profit_per_bird, profit_margin, cost_per_bird, avg_sale_price) %>%
  gt() %>%
  fmt_number(columns = c(revenue, cost, profit), decimals = 0) %>%
  fmt_number(columns = c(profit_per_bird, cost_per_bird, avg_sale_price), decimals = 0) %>%
  fmt_number(columns = c(profit_margin), decimals = 1) %>%
  cols_label(
    Batch = "Batch",
    revenue = "Revenue (UGX)",
    cost = "Cost (UGX)",
    profit = "Net Profit (UGX)",
    profit_per_bird = "Profit/Bird (UGX)",
    profit_margin = "Margin (%)",
    cost_per_bird = "Cost/Bird (UGX)",
    avg_sale_price = "Avg Price (UGX)"
  ) %>%
  tab_header(title = "Financial Performance — Batches 4–14") %>%
  data_color(
    columns = profit_margin,
    fn = function(x) ifelse(is.na(x), "#6c757d", ifelse(x >= 20, "#198754", ifelse(x >= 10, "#ffc107", "#dc3545")))
  )
```

## Bird Production

```{r}
batch_summ %>%
  select(Batch, birds_purchased, birds_sold, birds_mortality, mortality_rate) %>%
  gt() %>%
  fmt_number(columns = c(birds_purchased, birds_sold, birds_mortality), decimals = 0) %>%
  fmt_number(columns = c(mortality_rate), decimals = 1) %>%
  cols_label(
    Batch = "Batch",
    birds_purchased = "Purchased",
    birds_sold = "Sold",
    birds_mortality = "Lost (Mortality)",
    mortality_rate = "Mortality %"
  ) %>%
  tab_header(title = "Bird Production Summary — Batches 4–14") %>%
  data_color(
    columns = mortality_rate,
    fn = function(x) ifelse(is.na(x), "#6c757d", ifelse(x <= 4, "#198754", ifelse(x <= 7, "#ffc107", "#dc3545")))
  )
```

## Batch-by-Batch Details

```{r}
#| results: asis

for (b in archived_batch_nums) {
  b_str <- as.character(b)
  kpis <- jc_dashboard_kpis(df_archive, b_str)

  has_revenue <- kpis$revenue > 0
  status <- if (has_revenue) "Closed" else "Active"
  margin_text <- if (!is.na(kpis$profit_margin)) paste0(kpis$profit_margin, "%") else "N/A"

  cat(glue("\n\n### Batch {b} — {status}\n\n"))
  cat(glue("{kpis$num_birds} birds | Margin: {margin_text}\n\n"))
  cat(glue("| Metric | Value |\n"))
  cat(glue("|--------|-------|\n"))
  cat(glue("| Revenue (UGX) | {kpis$revenue_fmt} |\n"))
  cat(glue("| Cost (UGX) | {kpis$cost_fmt} |\n"))
  cat(glue("| Net Profit (UGX) | {kpis$net_profit_fmt} |\n"))
  cat(glue("| Cost/Bird (UGX) | {kpis$cost_per_bird_fmt} |\n"))
  cat(glue("| Profit/Bird (UGX) | {kpis$profit_per_bird_fmt} |\n"))
  cat("\n")
}
```

## P&L Statement

```{r}
# Batches 4-14 P&L from API data
pnl_batches <- sort(unique(as.integer(as.character(
  df_raw$batch[as.integer(as.character(df_raw$batch)) %in% archive_batches]
))))

# Start with categories scaffold from first batch
if (length(pnl_batches) > 0) {
  final_pnl <- jc_pnl_by_batch(df_raw, as.character(pnl_batches[1]))
  if (length(pnl_batches) > 1) {
    for (b in pnl_batches[-1]) {
      batch_pnl <- jc_pnl_by_batch(df_raw, as.character(b))
      final_pnl <- final_pnl %>% left_join(batch_pnl, by = "Category")
    }
  }

  # Format all numeric columns
  final_pnl <- final_pnl %>%
    mutate(across(starts_with("Batch"), ~format(., big.mark = ",", scientific = FALSE)))

  # Row styling
  indent_rows <- c(2, 4, 5, 6, 7, 9, 10, 11, 12, 13)
  header_rows <- c(1, 3, 8, 14)

  final_pnl %>%
    kbl(caption = "Profit & Loss — Archived Batches 4–14") %>%
    kable_paper("striped", full_width = FALSE) %>%
    add_indent(indent_rows) %>%
    row_spec(header_rows, bold = TRUE, color = "white", background = "#4287f5")
}
```

---

*[Back to Main Dashboard](index.html)*
